#!/usr/bin/env bash

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
RUNNER="$ROOT_DIR/run.sh"

if [ "$1" != "run" ]; then
    echo "Usage: icpc run <YEAR> <PROBLEM|all> OR icpc run changed"
    exit 1
fi

if [ "$2" = "changed" ]; then
    TMP_LIST=$(mktemp)

    # Pega arquivos modificados ou novos, ignorando deletados (D) 
    # NF>=3 garante profundidade mínima de pasta 
    git status --porcelain | grep -v "^ D" | awk '{print $NF}' | while read -r F; do
        DIR=$(echo "$F" | cut -d/ -f1,2)
        if [ -f "$DIR/solution.cpp" ] || [ -f "$DIR/solution.py" ]; then
            echo "$DIR" >> "$TMP_LIST"
        fi
    done

    if [ ! -s "$TMP_LIST" ]; then
        echo "Nenhuma modificação válida detectada."
        rm -f "$TMP_LIST"
        exit 0
    fi

    sort -u "$TMP_LIST" > "${TMP_LIST}.uniq"
    echo "Problemas detectados:"
    sed 's/^/  - /' "${TMP_LIST}.uniq"
    echo ""

    while read -r LINE; do
        Y="${LINE%/*}"
        P="${LINE#*/}"
        bash "$RUNNER" "$Y" "$P"
    done < "${TMP_LIST}.uniq"

    rm -f "$TMP_LIST" "${TMP_LIST}.uniq"
else
    if [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: icpc run <YEAR> <PROBLEM|all>"
        exit 1
    fi
    bash "$RUNNER" "$2" "$3"
fi
