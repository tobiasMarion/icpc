#!/usr/bin/env bash

# Detect script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If script is in a subdirectory (e.g., bin/), look for run.sh in parent directory
if [ -f "$SCRIPT_DIR/run.sh" ]; then
    RUNNER="$SCRIPT_DIR/run.sh"
elif [ -f "$SCRIPT_DIR/../run.sh" ]; then
    RUNNER="$SCRIPT_DIR/../run.sh"
else
    echo "Error: run.sh not found!"
    exit 1
fi

if [ "$1" != "run" ]; then
    echo "Usage: icpc run <YEAR> <PROBLEM|all> OR icpc run changed"
    exit 1
fi

if [ "$2" = "changed" ]; then
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "Error: not in a git repository!"
        exit 1
    fi

    TMP_LIST=$(mktemp)

    # Detect modified AND untracked files that are solutions or inputs/outputs
    # Using -uall to include untracked files
    git status --porcelain -uall | grep -v "^ D" | awk '{print $NF}' | while read -r F; do
        # Check if file matches pattern YEAR/PROBLEM/
        if [[ "$F" =~ ^[0-9]{4}/[^/]+/(solution\.(cpp|py)|input/|output/) ]]; then
            DIR=$(echo "$F" | cut -d/ -f1,2)
            # Check if a solution file exists
            if [ -f "$DIR/solution.cpp" ] || [ -f "$DIR/solution.py" ]; then
                echo "$DIR" >> "$TMP_LIST"
            fi
        fi
    done

    if [ ! -s "$TMP_LIST" ]; then
        echo "No valid changes detected."
        rm -f "$TMP_LIST"
        exit 0
    fi

    sort -u "$TMP_LIST" > "${TMP_LIST}.uniq"
    echo "Detected problems:"
    sed 's/^/  - /' "${TMP_LIST}.uniq"
    echo ""

    while read -r LINE; do
        Y="${LINE%/*}"
        P="${LINE#*/}"
        bash "$RUNNER" "$Y" "$P"
    done < "${TMP_LIST}.uniq"

    rm -f "$TMP_LIST" "${TMP_LIST}.uniq"
else
    if [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: icpc run <YEAR> <PROBLEM|all>"
        exit 1
    fi
    bash "$RUNNER" "$2" "$3"
fi
