#!/usr/bin/env bash

# Detect script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If script is in a subdirectory (e.g., bin/), look for run.sh in parent directory
if [ -f "$SCRIPT_DIR/run.sh" ]; then
    RUNNER="$SCRIPT_DIR/run.sh"
elif [ -f "$SCRIPT_DIR/../run.sh" ]; then
    RUNNER="$SCRIPT_DIR/../run.sh"
else
    echo "Error: run.sh not found!"
    exit 1
fi

# Help command
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "Usage: icpc <command>"
    echo ""
    echo "Commands:"
    echo "  run <year> <problem>  Run a specific problem"
    echo "  run <year> all        Run all problems for a year"
    echo "  run changed           Run only problems with git changes"
    echo "  debug                 Manual input mode for the current problem"
    echo "  --help, -h            Show this help message"
    exit 0
fi

# New debug command logic
if [ "$1" = "debug" ]; then
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "Error: not in a git repository!"
        exit 1
    fi

    # Detects alphanumeric directory names (like TEST or 2025)
    DIR=$(git status --porcelain -uall | grep -v "^ D" | awk '{print $NF}' | while read -r F; do
        if [[ "$F" =~ ^[^/]+/[^/]+/(solution\.(cpp|py)|input/|output/) ]]; then
            echo "$F" | cut -d/ -f1,2
            break
        fi
    done)

    if [ -z "$DIR" ]; then
        echo "Error: No valid changes detected."
        exit 1
    fi

    Y="${DIR%/*}"
    P="${DIR#*/}"
    
    export INTERACTIVE_MODE=1
    bash "$RUNNER" "$Y" "$P"
    exit 0
fi

if [ "$1" != "run" ]; then
    echo "Usage: icpc run <YEAR> <PROBLEM|all> OR icpc run changed OR icpc debug"
    exit 1
fi

if [ "$2" = "changed" ]; then
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "Error: not in a git repository!"
        exit 1
    fi

    TMP_LIST=$(mktemp)

    # Detect modified AND untracked files
    git status --porcelain -uall | grep -v "^ D" | awk '{print $NF}' | while read -r F; do
        if [[ "$F" =~ ^[^/]+/[^/]+/(solution\.(cpp|py)|input/|output/) ]]; then
            DIR=$(echo "$F" | cut -d/ -f1,2)
            if [ -f "$DIR/solution.cpp" ] || [ -f "$DIR/solution.py" ]; then
                echo "$DIR" >> "$TMP_LIST"
            fi
        fi
    done

    if [ ! -s "$TMP_LIST" ]; then
        echo "No valid changes detected."
        rm -f "$TMP_LIST"
        exit 0
    fi

    sort -u "$TMP_LIST" > "${TMP_LIST}.uniq"
    echo "Detected problems:"
    sed 's/^/  - /' "${TMP_LIST}.uniq"
    echo ""

    while read -r LINE; do
        Y="${LINE%/*}"
        P="${LINE#*/}"
        bash "$RUNNER" "$Y" "$P"
    done < "${TMP_LIST}.uniq"

    rm -f "$TMP_LIST" "${TMP_LIST}.uniq"
else
    if [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: icpc run <YEAR> <PROBLEM|all>"
        exit 1
    fi
    bash "$RUNNER" "$2" "$3"
fi
